<!DOCTYPE html>	
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no">
	<link rel="stylesheet" type="text/css" href="siimple.min.css">
	<!--<link rel="stylesheet" type="text/css" href="style.css">-->
	<link rel="shortcut icon" href="favicon.ico">
	<title>Sholat Settings</title>
<style>
/*body {font-family: Verdana, Arial, 'sans-serif';}*/
/*body {font-family: Consolas, monaco, monospace;}*/
.siimple-jumbotron-title, .siimple-table-cell {font-family: "Lucida Sans Typewriter", "Lucida Console", Monaco, "Bitstream Vera Sans Mono", monospace;}
</style>
</head>
<body>
<div class="siimple-content siimple-content--small">
  <div class="siimple-grid">
    
	  <div class="siimple-grid-row">
	    <div class="siimple-grid-col siimple-grid-col--12">
        <div class="siimple-box siimple-box--pink">
          <div class="siimple-box-title">Sholat Settings</div>
          <!--<div class="siimple-box-subtitle">This is the box subtitle</div>-->
          <!--<div class="siimple-box-detail">This is the box detail text</div>-->
        </div>
	    </div>
	  </div>

	  <div class="siimple-grid-row">
	    <div class="siimple-grid-col siimple-grid-col--12">
        <div class="siimple-tabs siimple-tabs--boxed siimple-tab--small">
          <a href="/"><div class="siimple-tabs-tab">Menu</div></a>
          <a href="/configlocation.html"><div class="siimple-tabs-tab">Location</div></a>
          <a href="/configsholat.html"><div class="siimple-tabs-tab">Sholat</div></a>
          <a href="/configledmatrix.html"><div class="siimple-tabs-tab">LedMatrix</div></a>
          <a href="/statussystem.html"><div class="siimple-tabs-tab">System Status</div></a>
        </div>
	    </div>
	  </div>
	  
	  <div class="siimple-grid-row">
	    <div class="siimple-grid-col siimple-grid-col--12">
	      <b><div id="status_box" class="alert alert-info"></div></b>
	    </div>
      <div class="siimple-grid-col siimple-grid-col--6">
      </div>
	  </div>
	  
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">Kota/Kab</label>
      </div>
      <div id="city" name="city" class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <!--<select class="siimple-select" onchange="updateLatLon(this.value); something(this.value);"></select>-->
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">Latitude</label>
      </div>
      <div id="latitude" name="latitude" class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <!--<input type="text" class="siimple-input" id="latitude" name="latitude" size="10" maxlength="10" value="">-->
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">Longitude</label>
      </div>
      <div id="longitude" name="longitude" class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <!--<input type="text" class="siimple-input" id="longitude" name="longitude" size="10" maxlength="10" value="">-->
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">Timezone</label>
      </div>
      <div id="timezone" name="timezone" class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">Calc Method</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
				<select id="calcMethod" name="calcMethod" class="siimple-select" onchange="something(this.value)">
				  <option style="display:none"></option>
					<option value="Jafari" label="Jafari">Jafari</option>
					<option value="Karachi" label="Karachi">Karachi</option>
					<option value="ISNA" label="ISNA">ISNA</option>
					<option value="MWL" label="MWL">MWL</option>
					<option value="Makkah" label="Makkah">Makkah</option>
					<option value="Egypt" label="Egypt">Egypt</option>
					<option value="Custom" label="Custom">Custom</option>
				</select>
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">Ashr Juristic</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
				<select class="siimple-select" id="asrJuristic" name="asrJuristic">
				  <option style="display:none" label=" "></option>
					<option value="Shafii">Shafii</option>
					<option value="Hanafi">Hanafi</option>
				</select>
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">HighLat Adj Method</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
					<select class="siimple-select" id="highLatsAdjustMethod" name="highLatsAdjustMethod">
					  <option style="display:none" label=" "></option>
						<option value="None">None</option>
						<option value="MidNight">MidNight</option>
						<option value="OneSeventh">OneSeventh</option>
						<option value="AngleBased">AngleBased</option>
					</select>
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">Fajr Angle</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="fajrAngle" name="fajrAngle" size="4" maxlength="4" value="">
      </div>
    </div>
	  
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">Maghrib Minutes</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="maghribAngle" name="maghribAngle" size="4" maxlength="4" value="">
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">Isha Angle</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="ishaAngle" name="ishaAngle" size="4" maxlength="4" value="">
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">offset Imsak</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="offsetImsak" name="offsetImsak" size="4" maxlength="4" value="">
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">offset Fajr</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="offsetFajr" name="offsetFajr" size="4" maxlength="4" value="">
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">offset Terbit</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="offsetSunrise" name="offsetSunrise" size="4" maxlength="4" value="">
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">offset Dhuhr</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="offsetDhuhr" name="offsetDhuhr" size="4" maxlength="4" value="">
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">offset Asr</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="offsetAsr" name="offsetAsr" size="4" maxlength="4" value="">
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">offset Sunset</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="offsetSunset" name="offsetSunset" size="4" maxlength="4" value="">
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">offset Maghrib</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="number" class="siimple-input" id="offsetMaghrib" name="offsetMaghrib" size="4" maxlength="4" value="">
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">offset Isha</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="offsetIsha" name="offsetIsha" size="4" maxlength="4" value="">
      </div>
    </div>
    
    <div style="display: none">
      <input type="text" id="confLocation" name="confLocation" maxlength="172" value="">
      <input type="text" id="confLocation" name="confLocation" maxlength="172" value="">
      <span id="lon"></span>
      <span id="lat"></span>
    </div>
    
    <br>
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--12 siimple-grid-col-sm--12">
        <div align="center">
        <div class="siimple-btn siimple-btn--red" onclick="sendConfig()">Save</div>
        </div>
      </div>
    </div>

	  
  </div>  
</div>

<!--<script id='papaparse' src="papaparse.min.js" type="text/javascript" charset="utf-8"></script>-->
<script language="javascript" type="text/javascript">

var ws = null;
var json;

window.onload = function () {
  getConfigValues("config/sholat");
  something();
  startSocket();
}
function startSocket(){
  ws = new WebSocket('ws://'+document.location.host+'/ws',['arduino']);
  ws.binaryType = "arraybuffer";
  ws.onopen = function(e){
		var obj = new Object();
    obj.url = window.location.pathname;
    var myJSON = JSON.stringify(obj);
    ws.send(myJSON);
  };
  ws.onclose = function(e){
  };
  ws.onerror = function(e){
    console.log("ws error", e);
  };
  ws.onmessage = function(e){
    var msg = "";
    if(e.data instanceof ArrayBuffer){
      msg = "BIN:";
      var bytes = new Uint8Array(e.data);
      for (var i = 0; i < bytes.length; i++) {
        msg += String.fromCharCode(bytes[i]);
      }
    } else {
      msg = "TXT:"+e.data;
      console.log(msg);
      if (isJSON(e.data))
      {
        var json = JSON.parse(e.data);
      }
    }
  };
}
// https://stackoverflow.com/questions/3710204/how-to-check-if-a-string-is-a-valid-json-string-in-javascript-without-using-try
function isJSON(str) {
  try {
      return (JSON.parse(str) && !!str);
  } catch (e) {
      return false;
  }
}

function getConfigValues(address) {
  var req = new XMLHttpRequest();
  if (req) {
    req.open("GET", address, true);
    req.addEventListener("load", reqListener);
    req.send();
  }
}
function reqListener () {
  if (isJSON(this.responseText)) {
    json = JSON.parse(this.responseText);
    console.log("Data received: ", json);
    //document.getElementById('confLocation').value = json.location;
    // document.getElementById('province').textContent = json.province;
    document.getElementById('city').textContent = json.city;
    document.getElementById('latitude').textContent = json.latitude;
    document.getElementById('longitude').textContent = json.longitude;
    document.getElementById('timezone').textContent = json.timezone;
    document.getElementById('calcMethod').value = json.calcMethod;
    document.getElementById('asrJuristic').value = json.asrJuristic;
    document.getElementById('highLatsAdjustMethod').value = json.highLatsAdjustMethod;
    document.getElementById('fajrAngle').value = json.fajrAngle;
    document.getElementById('maghribAngle').value = json.maghribAngle;
    document.getElementById('ishaAngle').value = json.ishaAngle;
    document.getElementById('offsetImsak').value = json.offsetImsak;
    document.getElementById('offsetFajr').value = json.offsetFajr;
    document.getElementById('offsetSunrise').value = json.offsetSunrise;
    document.getElementById('offsetDhuhr').value = json.offsetDhuhr;
    document.getElementById('offsetAsr').value = json.offsetAsr;
    document.getElementById('offsetSunset').value = json.offsetSunset;
    document.getElementById('offsetMaghrib').value = json.offsetMaghrib;
    document.getElementById('offsetIsha').value = json.offsetIsha;
    something();
  }
  else {
    console.log("Data received: ", json);
  }
}

function sendConfig(element) {
  json.saveconfig = window.location.pathname;
  delete json.province;
  delete json.city;
  delete json.timezone;
  delete json.latitude;
  delete json.longitude;
  json.calcMethod = document.getElementById('calcMethod').value;
  json.asrJuristic = document.getElementById('asrJuristic').value;
  json.highLatsAdjustMethod = document.getElementById('highLatsAdjustMethod').value;
  json.fajrAngle = parseInt(document.getElementById('fajrAngle').value);
  json.maghribAngle = parseInt(document.getElementById('maghribAngle').value);
  json.ishaAngle = parseInt(document.getElementById('ishaAngle').value);
  json.offsetImsak = parseFloat(document.getElementById('offsetImsak').value);
  json.offsetFajr = parseFloat(document.getElementById('offsetFajr').value);
  json.offsetSunrise = parseFloat(document.getElementById('offsetSunrise').value);
  json.offsetDhuhr = parseFloat(document.getElementById('offsetDhuhr').value);
  json.offsetAsr = parseFloat(document.getElementById('offsetAsr').value);
  json.offsetSunset = parseFloat(document.getElementById('offsetSunset').value);
  json.offsetMaghrib = parseFloat(document.getElementById('offsetMaghrib').value);
  json.offsetIsha = parseFloat(document.getElementById('offsetIsha').value);
  var myJSON = JSON.stringify(json);
  ws.send(myJSON);
  console.log("Data sent: ",myJSON);
}


  
  function setMsg(cls, text) {
  	sbox = document.getElementById('status_box');
  	sbox.className = "siimple-alert siimple-alert--" + cls;
  	sbox.textContent = text;
  	//console.log(text);
  }
  
  // https://stackoverflow.com/questions/3710204/how-to-check-if-a-string-is-a-valid-json-string-in-javascript-without-using-try
  function isJSON(str) {
    try {
        return (JSON.parse(str) && !!str);
    } catch (e) {
        return false;
    }
  }
  

	function something() {
    var calcMethod = document.getElementById('calcMethod').value;
    console.log("calcMethod:",calcMethod);
    if (calcMethod != "Custom" ) {
      document.getElementById('fajrAngle').disabled = true;
      document.getElementById('maghribAngle').disabled = true;
      document.getElementById('ishaAngle').disabled = true;
    } else {
      document.getElementById('fajrAngle').disabled = false;
      document.getElementById('maghribAngle').disabled = false;
      document.getElementById('ishaAngle').disabled = false;
    }
    
    var location = document.getElementById('city').value;
    if (location != "Custom" ) {
      document.getElementById('latitude').readOnly = true;
      document.getElementById('longitude').readOnly = true;
      document.getElementById('latitude').style.color = "#999999";
      document.getElementById('longitude').style.color = "#999999"; 
    } else {
      document.getElementById('latitude').readOnly = false;
      document.getElementById('longitude').readOnly = false;
      document.getElementById('latitude').style.color = "#000000";
      document.getElementById('longitude').style.color = "#000000"; 
    }
  }
  
  var allResults = [];
  


</script>
</body>
