<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="style.css" type="text/css" />
<div id="page">
<a href="index.htm"  class="btn btn--s">&lt;</a>&nbsp;&nbsp;<strong>Network Status</strong>

<table>
<tr>
	<td colspan="2">
	<span><hr></span>
</td>
</tr>
<tr>
	<td align="right">Hostname</td>
	<td>
		<span id="hostname"></span>
	</td>
</tr>
<tr>
	<td align="right">Mode</td>
	<td>
		<span id="mode"></span>
	</td>
</tr>
<tr>
	<td align="right">SSID</td>
	<td>
		<span id="ssid"></span>
	</td>
</tr>
<tr>
	<td align="right">STA IP</td>
	<td>
		<span id="sta_ip"></span>
	</td>
</tr>
<tr>
	<td align="right">STA Mac</td>
	<td>
		<span id="sta_mac"></span>
	</td>
</tr>
<tr>
	<td align="right">AP IP</td>
	<td>
		<span id="ap_ip"></span>
	</td>
</tr>
<tr>
	<td align="right">AP Mac</td>
	<td>
		<span id="ap_mac"></span>
	</td>
</tr>
<tr>
	<td align="right">Netmask</td>
	<td>
		<span id="netmask"></span>
	</td>
</tr>
<tr>
	<td align="right">Gateway</td>
	<td>
		<span id="gateway"></span>
	</td>
</tr>
<tr>
	<td align="right">DNS 0</td>
	<td>
		<span id="dns0"></span>
	</td>
</tr>
<tr>
	<td align="right">DNS 1</td>
	<td>
		<span id="dns1"></span>
	</td>
</tr>
<tr>
	<td colspan="2">
	<span><hr></span>
</td>
</tr>
</table>
<a style="horizontal-align: center" href="javascript:GetState(); initEvt()" class="btn btn--m btn--blue">Refresh</a>
</div>
<!--<script src="microajax.js"></script>-->
<script>
var ws = null;

window.onload = function () {
  startSocket();
  //startEvents();
}
function startSocket(){
  ws = new WebSocket('ws://'+document.location.host+'/ws',['arduino']);
  ws.binaryType = "arraybuffer";
  ws.onopen = function(e){
		var obj = new Object();
    obj.url = window.location.pathname;
    var myJSON = JSON.stringify(obj);
    ws.send(myJSON);
  };
  ws.onclose = function(e){
  };
  ws.onerror = function(e){
    console.log("ws error", e);
  };
  ws.onmessage = function(e){
    var msg = "";
    if(e.data instanceof ArrayBuffer){
      msg = "BIN:";
      var bytes = new Uint8Array(e.data);
      for (var i = 0; i < bytes.length; i++) {
        msg += String.fromCharCode(bytes[i]);
      }
      console.log(msg);
    } else {
      msg = "TXT:"+e.data;
      console.log(msg);
      if (isJSON(e.data)) {
        var json = JSON.parse(e.data);
        if (json.hasOwnProperty('hostname'))
        {
          document.getElementById("hostname").textContent = json.hostname;
          document.getElementById("mode").textContent = json.mode;
          document.getElementById("ssid").textContent = json.ssid;
          document.getElementById("sta_ip").textContent = json.sta_ip;
          document.getElementById("sta_mac").textContent = json.sta_mac;
          document.getElementById("ap_ip").textContent = json.ap_ip;
          document.getElementById("ap_mac").textContent = json.ap_mac;
          document.getElementById("netmask").textContent = json.netmask;
          document.getElementById("gateway").textContent = json.gateway;
          document.getElementById("dns0").textContent = json.dns0;
          document.getElementById("dns1").textContent = json.dns1;
        }
      }
    }
  };
}
function startEvents(){
  var es = new EventSource('/events');
  es.onopen = function(e) {
  };
  es.onerror = function(e) {
    if (e.target.readyState != EventSource.OPEN) {
    }
  };
  es.onmessage = function(e) {
    console.log("Event: " + e.data);
  };
  es.addEventListener('ota', function(e) {
  }, false);
  es.addEventListener('timeDate', function(e) {
    console.log("Event: " + e.data)
    if (isJSON(e.data))
    {
      var json = JSON.parse(e.data);
      if (json.hasOwnProperty('hostname'))
      {
        document.getElementById("hostname").textContent = json.hostname;
        document.getElementById("mode").textContent = json.mode;
        document.getElementById("ssid").textContent = json.ssid;
        document.getElementById("sta_ip").textContent = json.sta_ip;
        document.getElementById("sta_mac").textContent = json.sta_mac;
        document.getElementById("ap_ip").textContent = json.ap_ip;
        document.getElementById("ap_mac").textContent = json.ap_mac;
        document.getElementById("netmask").textContent = json.netmask;
        document.getElementById("gateway").textContent = json.gateway;
        document.getElementById("dns0").textContent = json.dns0;
        document.getElementById("dns1").textContent = json.dns1;
      }
    }
  }, false);
}
// https://stackoverflow.com/questions/3710204/how-to-check-if-a-string-is-a-valid-json-string-in-javascript-without-using-try
function isJSON(str) {
  try {
      return (JSON.parse(str) && !!str);
  } catch (e) {
      return false;
  }
}
</script>