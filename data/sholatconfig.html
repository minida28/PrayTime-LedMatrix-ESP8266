<!DOCTYPE html>	
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no">
	<link rel="stylesheet" type="text/css" href="siimple.min.css">
	<!--<link rel="stylesheet" type="text/css" href="style.css">-->
	<link rel="shortcut icon" href="favicon.ico">
	<title>Sholat Settings</title>
<style>
/*body {font-family: Verdana, Arial, 'sans-serif';}*/
/*body {font-family: Consolas, monaco, monospace;}*/
.siimple-jumbotron-title, .siimple-table-cell {font-family: "Lucida Sans Typewriter", "Lucida Console", Monaco, "Bitstream Vera Sans Mono", monospace;}
</style>
</head>
<body>
<div class="siimple-content siimple-content--small">
  <div class="siimple-grid">
    
	  <div class="siimple-grid-row">
	    <div class="siimple-grid-col siimple-grid-col--12">
        <div class="siimple-box siimple-box--pink">
          <div class="siimple-box-title">Sholat Settings</div>
          <!--<div class="siimple-box-subtitle">This is the box subtitle</div>-->
          <!--<div class="siimple-box-detail">This is the box detail text</div>-->
        </div>
	    </div>
	  </div>

	  <div class="siimple-grid-row">
	    <div class="siimple-grid-col siimple-grid-col--12">
        <div class="siimple-tabs siimple-tabs--boxed siimple-tab--small">
          <a href="/"><div class="siimple-tabs-tab">Menu</div></a>
          <a href="/info.html"><div class="siimple-tabs-tab">Info</div></a>
          <a href="/sholat.html"><div class="siimple-tabs-tab">Sholat Time</div></a>
        </div>
	    </div>
	  </div>
	  
	  <div class="siimple-grid-row">
	    <div class="siimple-grid-col siimple-grid-col--12">
	      <b><div id="status_box" class="alert alert-info"></div></b>
	    </div>
      <div class="siimple-grid-col siimple-grid-col--6">
      </div>
	  </div>
	  
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">Lokasi</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <select class="siimple-select" id="location" name="location" onchange="updateLatLon(this.value); something(this.value);"></select>
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">Latitude</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="latitude" name="latitude" size="10" maxlength="10" value="">
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">Longitude</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="longitude" name="longitude" size="10" maxlength="10" value="">
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">Timezone</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
				<select id="timeZone" name="timeZone" class="siimple-select" disabled>
				  <option style="display:none" label=" "></option>
					<option value="-120">GMT-12:00</option>
					<option value="-110">GMT-11:00</option>
					<option value="-100">GMT-10:00</option>
					<option value="-90">GMT-09:00</option>
					<option value="-80">GMT-08:00</option>
					<option value="-70">GMT-07:00</option>
					<option value="-60">GMT-06:00</option>
					<option value="-50">GMT-05:00</option>
					<option value="-40">GMT-04:00</option>
					<option value="-35">GMT-03:30)</option>
					<option value="-30">GMT-03:00</option>
					<option value="-20">GMT-02:00</option>
					<option value="-10">GMT-01:00</option>
					<option value="0">GMT+00:00</option>
					<option value="10">GMT+01:00</option>
					<option value="20">GMT+02:00</option>
					<option value="30">GMT+03:00</option>
					<option value="35">GMT+03:30</option>
					<option value="40">GMT+04:00</option>
					<option value="45">GMT+04:30</option>
					<option value="50">GMT+05:00</option>
					<option value="55">GMT+05:30</option>
					<option value="57">GMT+05:45</option>
					<option value="60">GMT+06:00</option>
					<option value="65">GMT+06:30</option>
					<option value="70">GMT+07:00</option>
					<option value="80">GMT+08:00</option>
					<option value="90">GMT+09:00</option>
					<option value="95">GMT+09:30</option>
					<option value="100">GMT+10:00</option>
					<option value="110">GMT+11:00</option>
					<option value="120">GMT+12:00</option>
					<option value="120">GMT+12:00</option>
					<option value="130">GMT+13:00</option>
				</select>
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">Calc Method</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
				<select id="calcMethod" name="calcMethod" class="siimple-select" onchange="something(this.value)">
				  <option style="display:none"></option>
					<option value="Jafari" label="Jafari">Jafari</option>
					<option value="Karachi" label="Karachi">Karachi</option>
					<option value="ISNA" label="ISNA">ISNA</option>
					<option value="MWL" label="MWL">MWL</option>
					<option value="Makkah" label="Makkah">Makkah</option>
					<option value="Egypt" label="Egypt">Egypt</option>
					<option value="Custom" label="Custom">Custom</option>
				</select>
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">Ashr Method</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
				<select class="siimple-select" id="asrMethod" name="asrMethod">
				  <option style="display:none" label=" "></option>
					<option value="0">Shafii</option>
					<option value="1">Hanafi</option>
				</select>
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">HighLat Adj Method</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
					<select class="siimple-select" id="highLatsAdjustMethod" name="highLatsAdjustMethod">
					  <option style="display:none" label=" "></option>
						<option value="0">None</option>
						<option value="1">MidNight</option>
						<option value="2">OneSeventh</option>
						<option value="3">AngleBased</option>
					</select>
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">Fajr Angle</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="fajrAngle" name="fajrAngle" size="4" maxlength="4" value="">
      </div>
    </div>
	  
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">Maghrib Minutes</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="maghribAngle" name="maghribAngle" size="4" maxlength="4" value="">
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">Isha Angle</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="ishaAngle" name="ishaAngle" size="4" maxlength="4" value="">
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">offset Imsak</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="offsetImsak" name="offsetImsak" size="4" maxlength="4" value="">
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">offset Fajr</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="offsetFajr" name="offsetFajr" size="4" maxlength="4" value="">
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">offset Terbit</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="offsetSunrise" name="offsetSunrise" size="4" maxlength="4" value="">
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">offset Dhuhr</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="offsetDhuhr" name="offsetDhuhr" size="4" maxlength="4" value="">
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">offset Asr</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="offsetAsr" name="offsetAsr" size="4" maxlength="4" value="">
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">offset Sunset</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="offsetSunset" name="offsetSunset" size="4" maxlength="4" value="">
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">offset Maghrib</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="number" class="siimple-input" id="offsetMaghrib" name="offsetMaghrib" size="4" maxlength="4" value="">
      </div>
    </div>
    
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--12">
        <label class="siimple-label">offset Isha</label>
      </div>
      <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--12">
        <input type="text" class="siimple-input" id="offsetIsha" name="offsetIsha" size="4" maxlength="4" value="">
      </div>
    </div>
    
    <div style="display: none">
      <input type="text" id="confLocation" name="confLocation" maxlength="172" value="">
      <input type="text" id="confLocation" name="confLocation" maxlength="172" value="">
      <span id="lon"></span>
      <span id="lat"></span>
    </div>
    
    <br>
    <div class="siimple-grid-row">
      <div class="siimple-grid-col siimple-grid-col--12 siimple-grid-col-sm--12">
        <div align="center">
        <div class="siimple-btn siimple-btn--red" onclick="sendConfig()">Save</div>
        </div>
      </div>
    </div>

	  
  </div>  
</div>

<script>


	window.onload = function ()
	{
		load("microajax.js","js", function() {
			// load("style.css","css", function() {
			  
				//setValues("/admin/sholatconfig");
				setTimeout(something, 500);
				load("papaparse.min.js","js", function() {
				  loadLocationDB();
				  wsOpen();
          //startPolling();
          //startConnectionTimer();
				});
			// });
		});
	}
	function load(e,t,n) {
		if("js"==t) {
			var a=document.createElement("script");
			a.src=e,
			a.type="text/javascript",
			a.async=!1,
			a.onload=function(){n()},
			document.getElementsByTagName("head")[0].appendChild(a)
		}
		else if("css"==t) {
			var a=document.createElement("link");
			a.href=e,
			a.rel="stylesheet",
			a.type="text/css",
			a.async=!1,
			a.onload=function(){n()},
			document.getElementsByTagName("head")[0].appendChild(a)
		}
	}
	
  var ws;
  var retries;
	var sendPingVar;
	var killed = false; // true if this client has closed the connection by its self (as instructed by esp)
	var startSecond;
	var connectionTimerVar;
  	
	function wsOpen() {
		if (ws === undefined || ws.readyState != 0) {
			if (retries)
				setMsg("red", "Connection timeout, retrying..");
			else
				setMsg("blue", "Connecting..");
			ws = new WebSocket("ws://" + location.host + "/ws");
			ws.binaryType = 'arraybuffer';
			ws.onopen = function(evt) {
			  console.log("WebSocket is open. Connected to " + evt.target.url, evt);
			  retries = 0; setMsg("green", "Connected");
			  //ws.send('Hallo from Browser :-) ' + new Date());
    		// setInterval(function(){ sendPing() }, 5000);
    		var obj = new Object();
        obj.url = window.location.pathname;
        var myJSON = JSON.stringify(obj);
        console.log(myJSON);
        ws.send(myJSON);
			};
    	ws.onclose = function(evt)     	{
    	  //console.log("WebSocket CLOSE ", evt);
    	  setMsg("red", "Disconnected");
    	  console.log("WebSocket close. Code: " + evt.code + ", Reason: " + evt.reason);
    	  clearInterval(sendPingVar); console.log(clearInterval.name);
    	  clearInterval(connectionTimerVar); console.log(clearInterval.name);
    	};
			ws.onerror = function(error) {
			  console.log("WebSocket ERROR ", error);
			  clearInterval(sendPingVar);console.log(clearInterval.name);
			  clearInterval(connectionTimerVar); console.log(clearInterval.name);
			  setMsg("red", "Connection error!");
			};
			ws.onmessage = function(evt) { onMessage(evt); };
			//wsOpenStream();
			//retries = 0;
		}
	}
  
  function onMessage(evt) {
  	retries = 0;
  	
    if (isJSON(evt.data)) {
      var json = JSON.parse(evt.data);
      console.log("Data received: ",json);
      document.getElementById('location').value = json.location;
      document.getElementById('latitude').value = json.latitude;
      document.getElementById('longitude').value = json.longitude;
      document.getElementById('timeZone').value = json.timezone;
      document.getElementById('calcMethod').value = json.calcMethod;
      document.getElementById('asrMethod').value = json.asrMethod;
      document.getElementById('highLatsAdjustMethod').value = json.highLatsAdjustMethod;
      document.getElementById('fajrAngle').value = json.fajrAngle;
      document.getElementById('maghribAngle').value = json.maghribAngle;
      document.getElementById('ishaAngle').value = json.ishaAngle;
      document.getElementById('offsetImsak').value = json.offsetImsak;
      document.getElementById('offsetFajr').value = json.offsetFajr;
      document.getElementById('offsetSunrise').value = json.offsetSunrise;
      document.getElementById('offsetDhuhr').value = json.offsetDhuhr;
      document.getElementById('offsetAsr').value = json.offsetAsr;
      document.getElementById('offsetSunset').value = json.offsetSunset;
      document.getElementById('offsetMaghrib').value = json.offsetMaghrib;
      document.getElementById('offsetIsha').value = json.offsetIsha;
    }
    else {
      console.log("Data received: ", evt.data);
    }
  }
  
  function setMsg(cls, text) {
  	sbox = document.getElementById('status_box');
  	sbox.className = "siimple-alert siimple-alert--" + cls;
  	sbox.textContent = text;
  	//console.log(text);
  }
  
  // https://stackoverflow.com/questions/3710204/how-to-check-if-a-string-is-a-valid-json-string-in-javascript-without-using-try
  function isJSON(str) {
    try {
        return (JSON.parse(str) && !!str);
    } catch (e) {
        return false;
    }
  }
  
	function sendConfig(element) {
    console.log(element);
    var type;
    var nodeName; var nodeId; var value; var text;
    if (element != undefined) {
      type = element.type;
    }

    if (type == 'select-one') {
      nodeName = element.nodeName; nodeId = element.id; value = element.value; text = element.options[element.selectedIndex].text;
    }
    else if (type == 'checkbox') {
      nodeName = element.nodeName; nodeId = element.id; value = element.checked; text = null;
    }
    else if (type == 'range') {
      nodeName = element.nodeName; nodeId = element.id; value = element.value; text = null;
    }
    else if (type == 'textarea') {
      nodeName = element.nodeName; nodeId = element.id; value = element.value; text = null;
    }
    console.log("nodeName:" + nodeName,"type:" + type,"nodeId:" + nodeId,"value:" + value,"text:" + text);
    var obj = new Object();
    obj.type = "sholatConfig";
    obj.location = document.getElementById('location').value;
    obj.latitude = document.getElementById('latitude').value;
    obj.longitude = document.getElementById('longitude').value;
    obj.timeZone = document.getElementById('timeZone').value;
    obj.calcMethod = document.getElementById('calcMethod').value;
    obj.asrMethod = document.getElementById('asrMethod').value;
    obj.highLatsAdjustMethod = document.getElementById('highLatsAdjustMethod').value;
    obj.fajrAngle = document.getElementById('fajrAngle').value;
    obj.maghribAngle = document.getElementById('maghribAngle').value;
    obj.ishaAngle = document.getElementById('ishaAngle').value;
    obj.offsetImsak = document.getElementById('offsetImsak').value;
    obj.offsetFajr = document.getElementById('offsetFajr').value;
    obj.offsetSunrise = document.getElementById('offsetSunrise').value;
    obj.offsetDhuhr = document.getElementById('offsetDhuhr').value;
    obj.offsetAsr = document.getElementById('offsetAsr').value;
    obj.offsetSunset = document.getElementById('offsetSunset').value;
    obj.offsetMaghrib = document.getElementById('offsetMaghrib').value;
    obj.offsetIsha = document.getElementById('offsetIsha').value;
    // obj.value = value;
    // obj.text = text;
    var myJSON = JSON.stringify(obj);
    ws.send(myJSON);
    console.log("Send data: ",myJSON);
  }
	
	function something() {
    var calcMethod = document.getElementById('calcMethod').value;
    console.log(calcMethod);
    if (calcMethod != "Custom" ) {
      document.getElementById('fajrAngle').disabled = true;
      document.getElementById('maghribAngle').disabled = true;
      document.getElementById('ishaAngle').disabled = true;
    } else {
      document.getElementById('fajrAngle').disabled = false;
      document.getElementById('maghribAngle').disabled = false;
      document.getElementById('ishaAngle').disabled = false;
    }
    
    var location = document.getElementById('location').value;
    if (location != "Custom" ) {
      document.getElementById('latitude').readOnly = true;
      document.getElementById('longitude').readOnly = true;
      document.getElementById('latitude').style.color = "#999999";
      document.getElementById('longitude').style.color = "#999999"; 
    } else {
      document.getElementById('latitude').readOnly = false;
      document.getElementById('longitude').readOnly = false;
      document.getElementById('latitude').style.color = "#000000";
      document.getElementById('longitude').style.color = "#000000"; 
    }
  }
  
  var allResults = [];
  
  function loadLocationDB() {
    console.log("Parsing location database..");
    Papa.parse("LocationDB.txt", {
      download: true,
      header: true,
      skipEmptyLines: true,
      comments: true,
      error: function(err, file, inputElem, reason) { /* handle*/ },
      complete: function(results) {
        console.log(results);
        allResults.push(results.data);
        console.log(allResults[0][0]);
        console.log("Number of location:", results.data.length); //number of location in db
        var locationIndex;
        var currLocation = document.getElementById('confLocation').value;
        for (var i = 0; i < results.data.length; i++) {
          var inputSelect = document.getElementById("location");
          if(currLocation.toUpperCase() === results.data[i].Location.toUpperCase()) {
            inputSelect.options[inputSelect.options.length] = new Option(results.data[i].Location, results.data[i].Location, true, true);
            console.log(results.data[i].Location);
          } else {
            inputSelect.options[inputSelect.options.length] = new Option(results.data[i].Location, results.data[i].Location);
          }
        }
        locationIndex = document.getElementById('location').selectedIndex;
        document.getElementById('lat').textContent = allResults[0][locationIndex].Lat;
        document.getElementById('lon').textContent = allResults[0][locationIndex].Lon;
        
        //document.getElementById('latitude').value = allResults[0][locationIndex].Lat;
        //document.getElementById('longitude').value = allResults[0][locationIndex].Lon;
      }
    });
  }
  
	function updateLatLon() {
    var locationIndex = document.getElementById('location').selectedIndex;
    console.log("Selected location:",document.getElementById('location')[locationIndex].text, "i=",locationIndex, "Lat:",allResults[0][locationIndex].Lat, "Lon:",allResults[0][locationIndex].Lon);

    document.getElementById('lat').textContent = allResults[0][locationIndex].Lat;
    document.getElementById('lon').textContent = allResults[0][locationIndex].Lon;
    document.getElementById('latitude').value = allResults[0][locationIndex].Lat;
    document.getElementById('longitude').value = allResults[0][locationIndex].Lon;

  }
  
  function startPolling() {
    console.log(startPolling.name);
		// setInterval(function() { wsWrite('A'); }, 1000);
		sendPingVar = setInterval(function() { sendPing(); }, 60000);
	}
  function startConnectionTimer() {
    //console.log(startPolling.name);
		// setInterval(function() { wsWrite('A'); }, 1000);
		document.getElementById("connTime").textContent = '0:00:00';
		var date1 = new Date();
		startSecond = date1.valueOf() / 1000;
		connectionTimerVar = setInterval(function() { connectionTimer(); }, 1000);
	}
  
  function sendPing() {
    ws.send('ping'); console.log(sendPing.name);
  }
  function connectionTimer() {
    var date2 = new Date();
    var current = date2.valueOf() / 1000;
    var timeDiff = current - startSecond;
    hours = Math.floor(timeDiff  / 3600);
    timeDiff %= 3600;
    minutes = Math.floor(timeDiff / 60);
    seconds = Math.floor(timeDiff % 60);
    document.getElementById("connTime").textContent = hours +':'+ ('0'+minutes).slice(-2) +':'+ ('0'+seconds).slice(-2);
    // console.log( hours +':'+ ('0'+minutes).slice(-2) +':'+ ('0'+seconds).slice(-2) );
  }

</script>
</body>
