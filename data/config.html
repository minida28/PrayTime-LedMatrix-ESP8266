<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="style.css">
<!--<script src="microajax.js" sync></script>-->
<a href="index.htm"  class="btn btn--s">&lt;</a>&nbsp;&nbsp;<strong>Network Settings</strong>
	<hr>
	<form action="" method="post">
		<table border="0"  cellspacing="0" cellpadding="3" >
      <tr>
          <td align="right">Device Name:</td>
          <td>
             <strong><span id="hostname"></span></strong>
          </td>
      </tr>
      <tr>
          <td align="right">SSID:</td>
          <td>
              <input type="text" id="ssid" name="ssid" value="">
          </td>
      </tr>
      <tr>
          <td align="right">Password:</td>
          <td>
              <input type="password" id="password" name="password" value="">
          </td>
      </tr>
      <tr>
          <td align="right">DHCP:</td>
          <td>
              <input type="checkbox" id="dhcp" name="dhcp">
          </td>
      </tr>
      <tr>
          <td align="right">IP:</td>
          <td>
              <input type="text" id="static_ip" name="static_ip">
          </td>
      </tr>
      <tr>
          <td align="right">Netmask:</td>
          <td>
              <input type="text" id="netmask" name="netmask">
          </td>
      </tr>
      <tr>
          <td align="right">Gateway:</td>
          <td>
              <input type="text" id="gateway" name="gateway">
          </td>
      </tr>
      <tr>
          <td align="right">DNS:</td>
          <td>
              <input type="text" id="dns" name="dns">
          </td>
      </tr>
			<tr>
				<td colspan="2" align="center">
				<input type="submit" style="width:150px" class="btn btn--m btn--blue" value="Save"></td>
			</tr>
		</table>
	</form>
	
  <hr>
  <strong>WIFI STATUS:</strong>
  <div id="connectionstate" onHTMLUpdate="something(this.value);">Checking...</div>
  <hr>
  <strong>SCAN WIFI</strong>
  <br>
  <span id="numNets">Scanning for wifi...</span>
  <br>
  <table border="0" cellspacing="0" cellpadding="3" style="width:100%, table-layout: fixed">
    <thead bgcolor='#DDDDDD'>
        <tr>
            <th style="width:60%">SSID</th>
            <th>Channel</th>
            <th style="width:15%">Secure</th>
            <th>RSSI</th>
        </tr>
    </thead>
    <tbody id="networks"></tbody>
    <tr>
      <td colspan="3" align="center">
        <a href="javascript:GetState(); getNetwork();" style="width:40%" class="btn btn--m btn--blue">Refresh</a>
      </td>
    </tr>
</table>


	<script language="javascript" type="text/javascript">
	
    function securityStr(security) {
        if      (security == 7) {
            return 'Open';
        }
        else if (security == 5) {
            return 'WEP';
        }
        else if (security == 2) {
            return 'WPA';
        }
        else if (security == 4) {
            return 'WPA2';
        }
        else if (security == 8) {
            return 'WPA/WPA2';
        }
    }

    function wifiScan(res) {
        var array;

        if (!res || (res.target.responseText == '[]')) {
            setTimeout(function () { getNetwork(); }, 5000);
            return;
        }
        array = JSON.parse(res.target.responseText);
        console.log(json);
        array.sort(function (a, b) { return a.rssi - b.rssi });
        array.reverse();
        document.getElementById("numNets").innerHTML = array.length + " networks found";
        var table = document.getElementById("networks");
        table.innerHTML = "";
        for (var i = 0; i < array.length; i++) {
            var row = document.createElement("tr");
            row.innerHTML = "<td><a href='javascript:selssid(\"" + array[i].ssid + "\")'>" + array[i].ssid + "</td><td>" + array[i].channel + "</td><td>" + securityStr(array[i].secure) + "</td><td>" + array[i].rssi + "</td>";
            table.appendChild(row);
        }
    }

    function getNetwork() {
        request = new XMLHttpRequest();
        if (request) {
            request.open("GET", "/scan", true);
            request.addEventListener("load", wifiScan)
            request.send();
        }
    }

    function GetState() {
        setValues("/admin/connectionstate");
    }
    function selssid(value) {
        document.getElementById("ssid").value = value;
    }
    
  function getConfigValues(address) {
    var req = new XMLHttpRequest();
    if (req) {
      req.open("GET", address, true);
      req.addEventListener("load", reqListener);
      req.send();
    }
  }
  
  function reqListener () {
    //console.log(this.responseText);
    var json = JSON.parse(this.responseText);
    console.log(json);
    // document.getElementById("ssid").value = json.ssid;
    // document.getElementById("password").value = json.password;
    // document.getElementById("dhcp").checked = json.dhcp;
    // document.getElementById("static_ip").value = json.ap_ip[0]+"."+json.ap_ip[1]+"."+json.ap_ip[2]+"."+json.ap_ip[3];
    // document.getElementById("netmask").value = json.netmask[0]+"."+json.netmask[1]+"."+json.netmask[2]+"."+json.netmask[3];
    // document.getElementById("gateway").value = json.gateway[0]+"."+json.gateway[1]+"."+json.gateway[2]+"."+json.gateway[3];
    // document.getElementById("dns").value = json.dns[0]+"."+json.dns[1]+"."+json.dns[2]+"."+json.dns[3];
  }
    
		function something() {
      var e = document.getElementById("connectionstate").innerHTML;
      // var operatingMode = e.options[e.selectedIndex].text;
      console.log(e);
      if (e == "CONNECTED" ) {
        e.style.color = "green";
      }
    }
    
    window.onload = function () {
            load("microajax.js", "js", function () {
                setValues("/config.json");
                getConfigValues("/config.json");
                setTimeout(GetState, 1000);
                setTimeout(getNetwork, 2000);
            });
    }

    function load(e, t, n) {
        if ("js" == t) {
            var a = document.createElement("script");
            a.src = e,
            a.type = "text/javascript",
            a.async = !1,
            a.onload = function () { n() },
            document.getElementsByTagName("head")[0].appendChild(a)
        } else if ("css" == t) {
            var a = document.createElement("link");
            a.href = e,
            a.rel = "stylesheet",
            a.type = "text/css",
            a.async = !1,
            a.onload = function () { n() },
            document.getElementsByTagName("head")[0].appendChild(a)
        }
    }

	</script>
