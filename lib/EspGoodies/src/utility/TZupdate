#!/bin/sh

csv=https://raw.githubusercontent.com/nayarsystems/posix_tz_db/master/zones.csv

input=.tempfile-zones.csv
names=.tempfile-names.txt
values=.tempfile-values.txt

set -e

test -r $input && mv $input $input.old.$$
wget -O $input $csv || curl $csv > $input

sed -e 's/^[^,]*,//g' -e 's,^,FPSTR(,g' -e 's,$,),g' < $input > $values
sed -e 's/^\([^,]*\),.*/#define TZ_\1/g' -e 's,["],,g' < $input | tr '/\-+' '_mp' > $names

(
cat << EOF

// autogenerated from $csv
// $(date -u)

#ifndef TZDB_H
#define TZDB_H

EOF

paste $names $values

cat << EOF

#endif // TZDB_H
EOF
) > TZ.h.new

mv TZ.h.new TZ.h
